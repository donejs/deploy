#!/usr/bin/env node
var fsx = require("fs-extra"),
	packpath = require("packpath"),
	bundle = require("../lib/package").package,
	services = require("../lib/services");

try {
	var packageJSON = fsx.readJsonSync(packpath.self() + "/package.json");
	donejsDeploy = {};
	if (packageJSON && packageJSON.donejs && packageJSON.donejs.deploy) {
		donejsDeploy = packageJSON.donejs.deploy;
		//bundle(donejsDeploy);
	} else {
		throw new Error("donejs section of package.json requires a "
			+ " 'deploy' property");
	}

	var selected = null;
	if (donejsDeploy.services) {
		if (process.argv.length > 2) {
			var name = process.argv[2];
			selected =
				services.selected(name, donejsDeploy.services, services.list());
		} else {
			selected =
				services.selected(null, donejsDeploy.services, services.list());
		}
	} else {
		throw new Error("donejs.deploy section of package.json requires a "
			+ " 'services' property");
	}

	if (!selected) {
		throw new Error("the service you specified is not available");
	} else {
		selected.service.deploy(selected.config, function(msg) {
			throw new Error(msg);
		});
	}
} catch (e) {
	console.error("ERROR -- " + e.message);
	process.exit(1);
}
