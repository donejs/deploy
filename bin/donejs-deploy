#!/usr/bin/env node
var fsx = require("fs-extra"),
	glob = require("glob"),
	services = require("../services");

var error = function(msg) {
	console.error("donejs deploy (error) -- " + msg)
	process.exit(1);
};

var packageJSON = fsx.readJsonSync(process.cwd() + "/package.json");
if (!packageJSON || !packageJSON.donejs || !packageJSON.donejs.deploy) {
	error("the donejs section of package.json requires a 'deploy' property");
}

var deploy = packageJSON.donejs.deploy;
if (!deploy.services) {
	error("donejs.deploy section of package.json requires a 'services' property");
}

var deployName = (process.argv.length > 2) ? process.argv[2] : null;
selected = services.selected(packageJSON, deployName, deploy.services, services.list(), error);
if (!selected) {
	error("the service you specified is not available");
}

console.log("donejs - deploying to '" + selected.config.type + "'");

var files = glob.sync((deploy.root || "dist") + "/**/*.*");
selected.service.deploy(packageJSON, selected.config, files, error);
